import{_ as i,c as a,o as n,ag as e}from"./chunks/framework.6d7lLjym.js";const c=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"docs/2024下/基于uni-app的小程序插件.md","filePath":"docs/2024下/基于uni-app的小程序插件.md","lastUpdated":1745852826000}'),p={name:"docs/2024下/基于uni-app的小程序插件.md"};function l(h,s,t,k,d,o){return n(),a("div",null,s[0]||(s[0]=[e(`<h2 id="_1-工程适配" tabindex="-1">1. 工程适配 <a class="header-anchor" href="#_1-工程适配" aria-label="Permalink to &quot;1. 工程适配&quot;">​</a></h2><p>介绍下基于 uni-app 的小程序插件的设计思想、使用方法、适配工作、性能优化等。</p><h3 id="_1-1-设计原则" tabindex="-1">1.1. 设计原则 <a class="header-anchor" href="#_1-1-设计原则" aria-label="Permalink to &quot;1.1. 设计原则&quot;">​</a></h3><p>简单易用，一套代码既能独立发布，又能当小程序插件。独立发布包含了 uni-app 支持的所有端，包括 H5、微信小程序、QQ 小程序等。所以目标是 n+1 端，额外的 1 就是小程序插件。</p><h3 id="_1-2-使用方法" tabindex="-1">1.2. 使用方法 <a class="header-anchor" href="#_1-2-使用方法" aria-label="Permalink to &quot;1.2. 使用方法&quot;">​</a></h3><p>在环境变量 <code>.env.local</code> 中新增 <code>VUE_APP_MP_PLUGIN = pluginRoot</code>。<code>pluginRoot</code> 会被当作插件目录名称。</p><p>启动命令如下：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 开发</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev:mp-plugin</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 发布</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build:mp-plugin</span></span></code></pre></div><p>然后在小程序开发者工具打开 <code>dist/dev/mp-weixin</code> 或者 <code>dist/build/mp-weixin</code> 进行调试、预览、上传等。</p><h3 id="_1-3-适配工作" tabindex="-1">1.3. 适配工作 <a class="header-anchor" href="#_1-3-适配工作" aria-label="Permalink to &quot;1.3. 适配工作&quot;">​</a></h3><p>包含以下几部分</p><ol><li>命令兼容</li><li>playground 自动生成</li><li>路径修复</li></ol><h4 id="_1-3-1-命令兼容" tabindex="-1">1.3.1. 命令兼容 <a class="header-anchor" href="#_1-3-1-命令兼容" aria-label="Permalink to &quot;1.3.1. 命令兼容&quot;">​</a></h4><p>默认 uni-app 脚手架不提供小程序插件编译命令，但提供了<a href="https://zh.uniapp.dcloud.io/tutorial/mp-weixin-plugin-dev.html" target="_blank" rel="noreferrer">相关文档</a>。</p><p>在结合我们项目过程中，踩了一些坑，这里记录下。主要是业务库为 monorepo 模式，由环境变量决定启动哪个子工程。为了启动小程序插件，以及兼容使用 npm，修改了 env.js 的逻辑，增加了环境变量中是否有小程序插件名称的判断，如果有则将其附在命令后面。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> dotenv</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dotenv&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> dotenvExpand</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dotenv-expand&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">spawnSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;child_process&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> os</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;os&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> platform</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> os.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">platform</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> myEnv</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dotenv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ path: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.env.local&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dotenvExpand.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">expand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(myEnv);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 执行真实的命令</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> realArgv</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> process.argv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">slice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> command </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;npm&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (platform </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;win32&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  command </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;npm.cmd&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> otherArgv</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;run&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">realArgv]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 根据环境变量中是否有 VUE_APP_MP_PLUGIN 插件名称以及命令关键词，决定是否添加插件参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">VUE_APP_MP_PLUGIN</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> realArgv[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;mp-wx-plugin&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  otherArgv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;--&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;--plugin&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">VUE_APP_MP_PLUGIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">spawnSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(command, otherArgv, { stdio: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;inherit&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre></div><p>注意 <code>--plugin</code> 前面必须有 <code>--</code>。</p><p><code>package.json</code> 增加命令如下：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dev:mp-plugin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;npm run env dev:custom mp-wx-plugin --plugin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;build:mp-plugin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;npm run env build:custom mp-wx-plugin --plugin&quot;</span></span></code></pre></div><p>以及文档中提到的 uni-app 自定义命令</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;uni-app&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;scripts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;mp-wx-plugin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;title&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;微信小程序插件&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;env&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;UNI_PLATFORM&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mp-weixin&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;define&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;MP-WX-PLUGIN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_1-3-2-playground-自动生成" tabindex="-1">1.3.2. playground 自动生成 <a class="header-anchor" href="#_1-3-2-playground-自动生成" aria-label="Permalink to &quot;1.3.2. playground 自动生成&quot;">​</a></h4><p>插件开发过程中需要一个小程序用来调试，具体可参见<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/plugin/development.html" target="_blank" rel="noreferrer">官方文档</a>，我这里暂且称之为 <code>playground</code>。</p><p>默认情况下，在 uni-app 工程开发小程序插件时，每次都要将产物复制到另一个地方，然后用开发者工具打开，才能调试。这种效率过于低下，于是写了一个插件，可以在 dev 和 build 模式下都自动生成 <code>playground</code>。</p><p>原理是在模板的子工程目录下，提前放一个 <code>mp-plugin-public</code> 的文件，里面包括 <code>doc/miniprogram/project.config.json</code> 这些 <code>playground</code> 的必要东西。然后在 <code>compiler.hooks.done</code> 生命周期中（也可以用其他类似钩子），复制该目录到插件产物的上一层，然后打开该层目录，就可以自动调试了，无需手动拷贝。</p><p>为什么要将 <code>mp-plugin-public</code> 放到子工程下呢，是考虑到每个子工程是单独的一个插件，有不同的名称、文档、示例。</p><p>为什么要命名为 <code>mp-plugin-public</code> 呢，是将其类比成了 H5 下的 <code>public</code> 目录，在打包过程中不会编译，只会复制。</p><h4 id="_1-3-3-路径修复" tabindex="-1">1.3.3. 路径修复 <a class="header-anchor" href="#_1-3-3-路径修复" aria-label="Permalink to &quot;1.3.3. 路径修复&quot;">​</a></h4><p>由于我们项目的结构有点深，<code>src/project/subProject</code>，以及引用了外层公共模块，比如 <code>src/component</code>，<code>src/local-logic</code> 等。uni-app 在编译这种层级项目时，会生成错误的引用路径，需要编译插件修复。</p><ol><li>引入公共模块错误</li></ol><p>举例来说，比如一个 <code>js</code> 文件中引用了 <code>../common/runtime.js</code>，插件需要从当前文件往上找 <code>common/runtime.js</code> 文件，找到了就返回正确的相对路径，并进行替换。替换结果可能为 <code>../../../common/runtime.js</code>。</p><p>另外，node_modules 下的引入路径也有问题，问题截图如下，也需要用类似方法修复。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_59464c49f1f4d685d6.png" width="600"><ol start="2"><li>使用了绝对路径</li></ol><p>参考下图，里面包含了错误的绝对路径，需要替换为正确的 <code>moduleId</code>。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_c3b9a672306f979192.png" width="600"><ol start="3"><li>getApp 找不到</li></ol><p>此外，低版本的 <code>uni-app</code> 在编译小程序插件时候，还会使用 <code>getApp</code>，由于插件并不支持这个API，所以会报错，可以升级到最新版本解决。</p><h2 id="_2-性能" tabindex="-1">2. 性能 <a class="header-anchor" href="#_2-性能" aria-label="Permalink to &quot;2. 性能&quot;">​</a></h2><p>小程序插件本质和小程序一样，先从优化小程序包体积开始。</p><p>先贴下最开始的包体积，方便对比。最开始总包 1.92MB。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_bd34e66ccf679453ac.png" width="500"><h3 id="_2-1-分类" tabindex="-1">2.1. 分类 <a class="header-anchor" href="#_2-1-分类" aria-label="Permalink to &quot;2.1. 分类&quot;">​</a></h3><p>小程序包可以分为公共部分和业务部分，公共部分又可分为第三方的和我们项目组的。</p><p>第三方公共包括：</p><ul><li>uni-app 相关 <ul><li>uni-mp-weixin/dist/index.js</li><li>vue-cli-plugin-uni/mp-runtime.esm.js</li><li>uni-i18n</li></ul></li><li>Press UI</li><li>crypto、md5</li><li>weapp-qrcode</li><li>qs</li><li>其他</li></ul><p>项目组公共包括：</p><ul><li>pmd-npm <ul><li>startApp</li><li>report</li><li>login</li><li>tools</li><li>...</li></ul></li><li>press-plus</li><li>src/api</li></ul><p>业务部分就是剩下的了，包括所有业务组件和业务逻辑。</p><p>优化不同部分内容的影响是不同的。对第三方库的优化，对影响所有使用它的项目，是影响力最大的。对项目组公共部分的优化，会影响项目组所有业务。对业务的优化，就只会影响当前业务了。</p><p>就这个项目而言，三方库体积并不大，最大的是业务和项目组公共部分。</p><h3 id="_2-2-减包思想" tabindex="-1">2.2. 减包思想 <a class="header-anchor" href="#_2-2-减包思想" aria-label="Permalink to &quot;2.2. 减包思想&quot;">​</a></h3><p>减包主要分下面几种情况：</p><ul><li>完全运行不到的代码</li><li>重复代码</li><li>可以用更简单方式替换的代码</li></ul><p>完全运行不到的代码，比如 <code>uni-i18n</code> 的大部分逻辑、缺少条件编译的 H5 逻辑。</p><p>重复代码常见的有两段逻辑相似，或者引入了同一个包的两个版本。</p><p>可以用更简单方式替换的代码，比如用小程序原生上报代替 <code>aegis</code>、用原生 <code>swiper</code> 代替 <code>press-swiper</code>、自己写 <code>btoa</code> 代替 <code>js-base64</code> 中的 <code>encode</code> 等。</p><h2 id="_3-优化点" tabindex="-1">3. 优化点 <a class="header-anchor" href="#_3-优化点" aria-label="Permalink to &quot;3. 优化点&quot;">​</a></h2><p>下面每条优化我都给出对比效果，以及其他项目也想要使用时，可以采用的方法。</p><h3 id="_3-1-press-ui" tabindex="-1">3.1. press-ui <a class="header-anchor" href="#_3-1-press-ui" aria-label="Permalink to &quot;3.1. press-ui&quot;">​</a></h3><p>press-ui 是核心组件库，虽然它可以减少的空间并不大，但是会对所有项目产生影响。</p><p>优化前有 51KB，通过按需加载，条件编译去掉H5环境的方法等，缩小到了 43KB。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_039c8690b63b5ed991.png" width="500"><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_eead7e4ae02154b544.png" width="500"><p>又发现打包的 CSS 中有一些没有用到的公共样式，比如 ellipsis, hairline 等，通过按需引入，又减少了 20KB。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_7d36e4a17dcd3a6e7d.png" width="500"><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_90a1a4de5db1f3e04e.png" width="500"><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_738d650545621823df.png" width="500"><p>其他项目想要用的话，直接升级最新版本 <code>press-ui</code> 即可。</p><p>另外 <code>press-icon-plus</code> 打包了所有的图标，但实际只用了其中一两个，这里可以用 <code>postcss</code> 插件将多余的图标去掉，省掉 11KB。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_a93e2ff3f43d41ae1e.png" width="500"><p>其他项目想要用的话，可以使用 <code>plugin-light</code> 中的 <code>remove-selector</code> 插件。</p><h3 id="_3-2-api-子仓库" tabindex="-1">3.2. api 子仓库 <a class="header-anchor" href="#_3-2-api-子仓库" aria-label="Permalink to &quot;3.2. api 子仓库&quot;">​</a></h3><p>尽管 <code>src/api</code> 已经做到了按需加载，只打包所需的接口，而不是所有接口，但依然有 25KB 的体积，这里一起优化下，直接使用调用 <code>post</code>，这部分体积可以直接降为 0。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_5d6ebcc7a781562fa8.png" width="500"><p>其他项目想要使用的话，需要自己修改代码。</p><p>--- 分割线</p><p>后面想了一下，<code>src/api</code> 这个库还是还有必要的，typescript 类型检查不可少。分析了一下为什么能占这么多体积，发现其引用了并非是按需加载的包，而是 <code>all-in-one</code> 的文件，而且即使是按需加载的包也有很多重复方法，这里我提取了一下。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_46c11f85cfb1f84211.png" width="500"><h3 id="_3-3-swiper" tabindex="-1">3.3. swiper <a class="header-anchor" href="#_3-3-swiper" aria-label="Permalink to &quot;3.3. swiper&quot;">​</a></h3><p>业务使用了 <code>press-swiper</code>，来实现了一个较为美观的<code>swiper</code>。我研究了一番，直接用原生实现了。</p><p>核心原理如下：</p><ol><li>通过 <code>next-margin</code>，<code>previous-margin</code>， 实现 <code>swiper-item</code> 不再撑满全屏</li><li>通过 <code>getSystemInfo</code> 获取 <code>windowWidth</code>，减去 <code>wrapMargin</code>、<code>imageWidth</code> 等值，动态计算 <code>next-margin</code> 和 <code>previous-margin</code></li><li>监听 <code>transition</code> 事件，获取 <code>event.detail.dx</code>，计算当前<code> swiper-item</code>，并赋值，实现滑动切换 <code>swiper</code></li></ol><p>贴一下核心代码，备忘下。</p><div class="language-html vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- #ifndef H5 --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">swiper</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  v-if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mSwiperInit&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ref</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zSwiper&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  v-model</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mGameTaskList&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  :options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ZSwiperOptions&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  :current</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mCurrentSelectedTab&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  :next-margin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;nextMargin&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  :previous-margin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;nextMargin&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  @transition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;onSwiperTransition&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  @animationfinish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;onSwiperTransitionFInish&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  @touchstart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;onTouchStart&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  @touchmove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;onTouchMove&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  @touchend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;onTouchEnd&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">swiper-item</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    v-for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;(item,index) in mGameTaskList&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    :key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;index&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;task-type-item&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      :class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;task-type-item--active&#39;: mCurrentSelectedTab === index</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      }&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      @click.stop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;changeSelectedGame(index, true)&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">img</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;task-type-img&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        :src</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tinyImage(item.icon)&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">swiper-item</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">swiper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- #endif --&gt;</span></span></code></pre></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">methods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onSwiperTransition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.detail;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.manualMoving) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    movingDx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dx;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onSwiperTransitionFInish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {},</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onTouchStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clearTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.manualMoving </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.movingCurrent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.mCurrentSelectedTab;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    movingDx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onTouchMove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {},</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onTouchEnd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.manualMoving </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (movingDx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      current </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.movingCurrent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">round</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(movingDx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.mGameTaskList.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      current </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.movingCurrent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">round</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(movingDx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">changeSelectedGame</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">startTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getSwiperDomWidth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> that</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      wx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSystemInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        success</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> clientWidth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> res.windowWidth;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ratio</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 750</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> clientWidth;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> wrapWidth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> clientWidth </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ratio) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ratio) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nextMargin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (wrapWidth </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">104</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ratio) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ratio) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          that.nextMargin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nextMargin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}px\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这样优化后，发现切换 <code>swiper-item</code> 更加平滑，并直接省掉了 <code>176KB</code> 的大小。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_540e35e2212afd174d.png" width="500"><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_bdd6a42f8069e60029.png" width="500"><p>效果如下：</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_2014d9c6eb9f6f272b.gif" width="375"><p>其他项目想要使用的话，可以使用封装好的方法。</p><h3 id="_3-4-uni-i18n" tabindex="-1">3.4. uni-i18n <a class="header-anchor" href="#_3-4-uni-i18n" aria-label="Permalink to &quot;3.4. uni-i18n&quot;">​</a></h3><p>这个库是 uni-app 内部用来实现国际化的，业务没有用到，写了一个 <code>loader</code> 把它去掉了（只暴露了一个假的函数，返回最小需要的对象），可以省掉 7.5KB 的大小。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_cc1bc0dc96109135bd.png" width="500"><p>其他项目想要使用的话，可以给 <code>plugin-light</code> 的 <code>getUniVueConfig</code> 传入</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replaceLibraryLoaderOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  replaceContentList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      path: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;uni-i18n.es.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      content</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;export function initVueI18n() {return {t:()=&gt;{}}}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span></code></pre></div><p>也可以直接使用 <code>replaceLibraryLoader</code>，传入相同参数。</p><h3 id="_3-5-js-base64" tabindex="-1">3.5. js-base64 <a class="header-anchor" href="#_3-5-js-base64" aria-label="Permalink to &quot;3.5. js-base64&quot;">​</a></h3><p>业务主要用到了这个库的 <code>encode</code> 方法，其实就是 <code>window.btoa</code>，这个自己实现下小程序端的就行了。</p><p>从引用关系看，<code>js-base64</code> 引入了 <code>buffer.js</code>，<code>buffer.js</code> 又引入了其他的工具函数，所以去掉 <code>js-base64</code> 可以优化出比预期较多的体积，实际大概 25.89KB。</p><p>之前 JS 总体积：</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_1aa7454104cc5e6542.png" width="500"><p>去掉 <code>js-base64</code> 后的 JS 总体积：</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_4c73a0420f2de42cc5.png" width="500"><p><code>buffer.js</code> 体积：</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_02514049b673f9a00c.png" width="500"><p><code>buffer.js</code> 引用的子模块：</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_c58b5ef0d8ad6031f1.png" width="500"><p>其他项目想要使用的话，手动替换 <code>encode/decode</code> 到 <code>t-comm</code> 或者 <code>pmd-tools</code> 中的方法。</p><h3 id="_3-6-pmd" tabindex="-1">3.6. pmd <a class="header-anchor" href="#_3-6-pmd" aria-label="Permalink to &quot;3.6. pmd&quot;">​</a></h3><h4 id="_3-6-1-pmd-vue" tabindex="-1">3.6.1. pmd-vue <a class="header-anchor" href="#_3-6-1-pmd-vue" aria-label="Permalink to &quot;3.6.1. pmd-vue&quot;">​</a></h4><ul><li><p><code>launchapp/base.ts</code> 中都是 H5 的拉起方法，用条件编译去掉</p></li><li><p>去掉 <code>initReport</code>，因为没有 <code>aegis</code> 了，这个引用也就没意义了</p></li><li><p>去掉 <code>initFilter</code>，没有用到</p></li><li><p>去掉 <code>initMixin</code>，使用工具方法</p></li></ul><h4 id="_3-6-2-pmd-tools" tabindex="-1">3.6.2. pmd-tools <a class="header-anchor" href="#_3-6-2-pmd-tools" aria-label="Permalink to &quot;3.6.2. pmd-tools&quot;">​</a></h4><ul><li><p><code>env/user-agent.ts</code> 小程序中用不到，用关键词编译方法去掉</p></li><li><p><code>validate/index.ts</code> 中只用到了 <code>getType</code> 方法，把它单独拿出来引用</p></li><li><p><code>dialog-displayer/index.ts</code> 小程序中用不到，用关键词编译方法去掉</p></li><li><p><code>time</code> 模块太大，用到的其中几个方法，把它们单独提出来，单独引用</p></li></ul><h4 id="_3-6-3-pmd-report" tabindex="-1">3.6.3. pmd-report <a class="header-anchor" href="#_3-6-3-pmd-report" aria-label="Permalink to &quot;3.6.3. pmd-report&quot;">​</a></h4><p><code>tcss</code> 已废弃，直接去掉</p><p>其他项目想用的话，手动替换。</p><h3 id="_3-7-scoped" tabindex="-1">3.7. scoped <a class="header-anchor" href="#_3-7-scoped" aria-label="Permalink to &quot;3.7. scoped&quot;">​</a></h3><p>突然意识到小程序根本不需要 <code>scoped</code>，默认情况下，小程序组件样式就是只能作用于自己。于是写了个 <code>loader</code>，在小程序下去掉了所有 <code>scoped</code>，减少了 47KB。</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_28e1864b844799c811.png" width="500"><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_bfad98a1eb69e896e3.png" width="500"><p>其他项目想用的话，使用 <code>plugin-light</code> 中的 <code>removeScopedLoader</code>。</p><h3 id="_3-8-最新进度" tabindex="-1">3.8. 最新进度 <a class="header-anchor" href="#_3-8-最新进度" aria-label="Permalink to &quot;3.8. 最新进度&quot;">​</a></h3><p>当前总包 1.512 MB</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_d34295e3ea4044dedc.png" width="500"><h2 id="_4-vue3" tabindex="-1">4. Vue3 <a class="header-anchor" href="#_4-vue3" aria-label="Permalink to &quot;4. Vue3&quot;">​</a></h2><h3 id="_4-1-包体积" tabindex="-1">4.1. 包体积 <a class="header-anchor" href="#_4-1-包体积" aria-label="Permalink to &quot;4.1. 包体积&quot;">​</a></h3><p>尝试用 Vue3 改写了项目，包体积能降到 900KB。</p><p>看了下，之所以能降这么多，除了 <code>uni-app</code> 运行时变小外，<code>js</code> 文件的运行时也缩减了很多。<code>Vue2.x</code> 用的 <code>webpack</code> 运行时那一套，熟悉的关键词是 <code>webpackJsonP</code>，而 <code>Vue3.x</code> 用的是 <code>Vite</code>，到了小程序这，转化成了小程序原生的 <code>require</code>。就这一点，就能降不少，因为 JS 模块太多了。</p><p>下面记录下 Vue3 升级中的一些问题和解决办法。</p><h3 id="_4-2-vue2-中的-set" tabindex="-1">4.2. Vue2 中的 $set <a class="header-anchor" href="#_4-2-vue2-中的-set" aria-label="Permalink to &quot;4.2. Vue2 中的 $set&quot;">​</a></h3><p><code>Vue.set</code> 和 <code>this.$set</code> 区别</p><p>说明：两者都是实现向实例对象中添加响应式属性，触发视图更新，两者原理和用法基本相同，都是使用 set,一个绑定在 vue 的构造函数身上，一个绑定在vue的原型身上。</p><ol><li><code>vue.set()</code>，将 set 函数绑定在 Vue 构造函数中，设置实例创建之后添加的新的响应式属性，且触发视图更新，但是不允许添加根级响应式属性，只可以向嵌套对象添加响应式属性。</li></ol><p>用法： <code>Vue.set(object, propertyName, value)</code></p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { set } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;../observer/index&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Vue.set </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> set</span></span></code></pre></div><ol start="2"><li><code>this.$set()</code>**将 set 函数绑定在 vue 原型上，**只能设置实例创建后存在的数据（数据已经在 data 中）</li></ol><p>用法： <code>this.$set(object, propertyName, value)</code></p><p>第一个参数是要添加的对象，第二个是需要添加的属性名key（需要要用引号包裹起来),第三个是需要添加的值)</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { set } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;../observer/index&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">prototype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.$set </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> set</span></span></code></pre></div><h3 id="_4-3-maximum-recursive-updates-exceeded" tabindex="-1">4.3. Maximum recursive updates exceeded <a class="header-anchor" href="#_4-3-maximum-recursive-updates-exceeded" aria-label="Permalink to &quot;4.3. Maximum recursive updates exceeded&quot;">​</a></h3><p>出现了死循环，报错如下：</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_abb7c22e5de1650fee.png" width="500"><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Maximum recursive updates exceeded. This means you have a reactive effect</span></span>
<span class="line"><span>that is mutating its own dependencies vendor.j5: 3. and thus recursively</span></span>
<span class="line"><span>triggering itself. Possible sources include component template, render</span></span>
<span class="line"><span>function, updated hook or watcher source</span></span></code></pre></div><p>最后发现是 <code>watch</code> 使用的不合理，原先代码抽象如下（选项式API）：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">props</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: Object,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mTaskInfo: {},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">watch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.mTaskInfo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>上面代码在 <code>Vue2.x</code> 时候也是不对的，完全可以用 <code>computed</code>。只不是 <code>Vue2.x</code> 的时候传递的是对象，并不是代理，所以不会出现死循环。</p><p>而 <code>Vue3.x</code> 中传入的这个 <code>task</code> 是代理对象，执行 <code>this.mTaskInfo = value</code> 的时候，等于把 <code>mTaskInfo</code> 和 <code>task</code> 划上了等号，一旦对 <code>mTaskInfo</code> 的属性赋值，都会导致 <code>task</code> 也跟着变，从而死循环。</p><p>测试了一下，选项式API中 <code>data</code> 的属性，如果是基础类型可以获取到原始类型，如果是对象和数组则是代理。<code>computed</code> 中返回的则始终是原始值。</p><h3 id="_4-4-h5标签转化" tabindex="-1">4.4. H5标签转化 <a class="header-anchor" href="#_4-4-h5标签转化" aria-label="Permalink to &quot;4.4. H5标签转化&quot;">​</a></h3><p>vue3 不会在 <code>img/div/span</code> 这些 H5 标签转化的产物中加额外类名了，比如 <code>_img/_div/_span</code>，之前是</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_7223075d1382090f18.png" width="360"><p>现在是</p><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_a07d3a1975fd25f5ae.png" width="360"><p>需要自己改成</p><div class="language-scss vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">scss</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">img</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>更正规的做法是不要使用标签选择器，统一使用类名选择器。</p><p>还有一种批量处理方法，就是找到对应关系，用 <code>postcss</code> 插件批量转化。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>span =&gt; label</span></span>
<span class="line"><span>img =&gt; image</span></span>
<span class="line"><span>i =&gt; view</span></span>
<span class="line"><span>p =&gt; view</span></span></code></pre></div><p>用插件的优点就是很快，缺点是：</p><ol><li>不精确，多个web标签都对应 view，可能会导致与 Web 端表现不一致</li><li>有心智负担，无法做到可见即所得，不利于后期维护</li></ol><h2 id="_5-vue3-转化-tips" tabindex="-1">5. Vue3 转化 Tips <a class="header-anchor" href="#_5-vue3-转化-tips" aria-label="Permalink to &quot;5. Vue3 转化 Tips&quot;">​</a></h2><p>为方便其他子工程迁移，贴下转化的基础步骤。</p><h3 id="_5-1-框架级别" tabindex="-1">5.1. 框架级别 <a class="header-anchor" href="#_5-1-框架级别" aria-label="Permalink to &quot;5.1. 框架级别&quot;">​</a></h3><ol><li>复制 <code>main.ts</code></li><li>删掉 <code>index.html</code> 中的 <code>VUE_APP_INDEX_CSS_HASH</code></li><li>在 <code>index.html</code> 增加 <code>main.ts</code> 中的引入</li></ol><div class="language-html vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;module&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> src</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/main.ts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><ol start="4"><li><p><code>manifest.json</code> 中 <code>vueVersion</code> 改成 3</p></li><li><p><code>pmd-merchant-ui</code> 替换，<code>pmd-merchant-ui/src/tip-comp-dialog-prompt/css</code> =&gt; <code>press-plus/press-act-prompt-dialog/css</code></p></li></ol><h3 id="_5-2-业务级别" tabindex="-1">5.2. 业务级别 <a class="header-anchor" href="#_5-2-业务级别" aria-label="Permalink to &quot;5.2. 业务级别&quot;">​</a></h3><ol><li><code>app.$set</code> 和 <code>this.$set</code> 用 <code>press-ui</code> 中的 <code>setAdapter</code> 替换。</li></ol><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { setAdapter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;press-ui/common/vue3/set&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><ol start="2"><li><p><code>router.push</code>， <code>router.replace</code> 在小程序下，用原生方法实现。</p></li><li><p>样式文件中的 <code>*</code> 选择器去掉，小程序不支持</p></li><li><p>生命周期替换</p></li><li><p>引入类型，需要加 <code>type</code></p></li></ol><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { XXType } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;xx&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><ol start="6"><li>Vant 组件改成 Press UI 组件，常见的包括 List/Tab/Swiper 等。</li></ol><h2 id="_6-赛事转化" tabindex="-1">6. 赛事转化 <a class="header-anchor" href="#_6-赛事转化" aria-label="Permalink to &quot;6. 赛事转化&quot;">​</a></h2><p>转化步骤：</p><ol><li>拷贝文件</li><li>运行 <code>npm run dev</code>, 改一些问题</li><li>运行 <code>npm run build</code> 改编译问题</li><li>再运行 <code>npm run dev</code> 改运行时问题</li></ol><p>先执行 <code>npm run dev</code> 是因为 <code>Vite</code> 按需加载，能较快看到成果，心里有底。</p><p>再执行 <code>npm run build</code> 是因为 <code>build</code> 模式能看到所有编译问题，方便快速定位和解决。</p><p>最后运行 <code>npm run dev</code> 就是查漏补缺，把每个页面的运行时都检查一遍。</p><p>编译问题：</p><ol><li>路径移动，需与之前项目融合，所以要改动引入路径部分</li><li>业务大量使用了 Vuex，去掉有风险，也引入 <code>4.x</code> 版本的 Vuex</li><li><code>template</code> 内的 key 需要写在 <code>template</code> 标签上</li><li><code>vue-qrcode</code> 库替换成 press-ui 中的 <code>qrcode</code></li><li><code>vant/lib</code> 库的动态引入，用条件编译包裹</li><li><code>@ttt/pmd-api</code> 替换成 <code>src/api</code></li><li>增加必须的 <code>mixin</code>，比如 <code>share-mixin</code></li></ol><p>运行时问题：</p><ol><li>业务大量使用了 <code>$router</code>，需要改成 <code>uni.navigateTo</code> 等</li><li>空的 <code>template</code> 标签会产生 <code>fragment</code>，导致白屏</li><li>对 <code>img/span/i</code> 等标签进行转换，可以用插件，用插件的优劣见上面。</li><li>在页面中，对 <code>global-component</code> 等组件进行手动注入</li></ol><h2 id="_7-冰山之下" tabindex="-1">7. 冰山之下 <a class="header-anchor" href="#_7-冰山之下" aria-label="Permalink to &quot;7. 冰山之下&quot;">​</a></h2><p>上层业务改动其实只是冰山之上，做了一些对普通开发者无感知的工程相关工作，是冰山之下，这里介绍下。</p><ol><li>脚手架</li><li>通用Vite配置</li><li>H5发布</li><li>小程序CI</li><li>合包流失线</li><li>统一的代码规范</li><li>组件库和工具库的兼容</li></ol><h3 id="_7-1-通用-vite-配置" tabindex="-1">7.1. 通用 Vite 配置 <a class="header-anchor" href="#_7-1-通用-vite-配置" aria-label="Permalink to &quot;7.1. 通用 Vite 配置&quot;">​</a></h3><p>通用 Vite 配置兼容项目底层库，让业务无缝升级 Vue3，具体包括以下内容。</p><h4 id="_7-1-1-插件支持" tabindex="-1">7.1.1. 插件支持 <a class="header-anchor" href="#_7-1-1-插件支持" aria-label="Permalink to &quot;7.1.1. 插件支持&quot;">​</a></h4><ol><li>支持条件编译</li><li>支持关键词跨平台文件编译</li><li>支持关键词跨平台样式编译</li><li>支持 <code>rem</code> 转 <code>rpx</code></li><li>支持小程序下转化 <code>v-lazy</code> 指令</li><li>支持小程序下去掉 Vue 指令</li><li>支持构建产物分析</li><li>支持 QQ 小程序下中 <code>globalThis polyFill</code></li><li>支持输出版本信息</li><li>支持输出不兼容语法的警告信息</li><li>支持动态修改 <code>vue.runtime.js</code>，解决编译问题</li></ol><img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/9/own_mike_ba280fde6f7614a7a2.png" width="500"><h4 id="_7-1-2-插件修复-uni-app-内部问题" tabindex="-1">7.1.2. 插件修复 uni-app 内部问题 <a class="header-anchor" href="#_7-1-2-插件修复-uni-app-内部问题" aria-label="Permalink to &quot;7.1.2. 插件修复 uni-app 内部问题&quot;">​</a></h4><ol><li>修复 uni-app 中自带 <code>useRem</code> 函数带来的样式适配问题</li></ol><p>uni-app Vue2 版本的 H5 会把 <code>rpx</code> 转成 <code>px</code>，在 Vue3 版本中，会把 <code>rpx</code> 转成 <code>rem</code>，且算法与我们业务不一样，并且即使你没用 <code>rpx</code>，他也会在 <code>html</code> 挂上他计算出来的 <code>font-size</code>，这个必须去掉。查看源码，其实就是这个 <code>useRem</code> 函数，这里写了插件用 <code>AST</code> 去掉。</p><p>至于 Vue2 版本中是如何将 <code>rpx</code> 转成 <code>px</code> 的，可以看 <code>node_modules/@dcloudio/vue-cli-plugin-uni/packages/postcss/index.js</code> 文件，其是一个 <code>postcss</code> 插件，会把 <code>rpx</code> 先转成 <code>%?\${num}?%</code> 这种格式，然后在 <code>styleLoader</code> 中将符合该正则的字符串通过 <code>upx2px</code> 转成 <code>px</code>。</p><ol start="2"><li>修复 uni-app 中 <code>monorepo</code> 仓库下打包路径问题</li></ol><p>uni-app 运行时生成的引用路径错误，查看源码发现是 <code>packages/uni-cli-shared/src/utils.ts</code> 中的问题:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> normalizeMiniProgramFilename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  filename</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  inputDir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">inputDir </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">path.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isAbsolute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> normalizeNodeModules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> normalizeNodeModules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(path.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">relative</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(inputDir, filename))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这里举个例子，<code>filename</code> 为 <code>/Users/yang/Documents/git-a/guandan-match/node_modules/press-ui/press-info/press-info.vue</code>，<code>inputDir</code> 为 <code>./src/project/guandan-match</code> 时，<code>path.relative</code> 生成的路径就会带上 <code>../</code>，这里背后的逻辑是 <code>inputDir</code> 和 <code>node_modules</code> 必须是同一级。</p><p>uni-app 社区也有其他人遇到了相同问题，参见：</p><ul><li><a href="https://ask.dcloud.net.cn/question/152306" target="_blank" rel="noreferrer">https://ask.dcloud.net.cn/question/152306</a></li><li><a href="https://github.com/dcloudio/uni-app/issues/3049" target="_blank" rel="noreferrer">https://github.com/dcloudio/uni-app/issues/3049</a></li></ul><p>如何解决呢？</p><p>尝试了覆盖 <code>rollupOptions</code>，发现不够，采用的是脚本改源码 + 插件修改 <code>rollupOptions.output.chunkFileNames</code>。</p><ol><li>修复 uni-app QQ小程序打包后 <code>appId</code> 错误问题</li></ol><p>这个解决办法就是用插件将 <code>manifest.json</code> 中正确的 <code>appId</code> 复制到产物中。</p><ol start="4"><li>修复 uni-app 小程序下样式文件变化无法重新编译的问题</li></ol><p>小程序开发时，独立的 <code>sass</code> 文件改动后并不会重新编译，用一个全新的示例工程也不可以。看了下源码，uni-app 是用 <code>import(&#39;vite&#39;).then({build}=&gt;{})</code> 这种方式来启动的。</p><p>解决办法是利用 <code>gulp.watch</code>，监听 <code>./src/**/*.scss</code> 文件，然后修改下 <code>main.ts</code>，然后这样就能重新编译了。同时加上了 <code>debounce</code>。</p><h4 id="_7-1-3-配置支持" tabindex="-1">7.1.3. 配置支持 <a class="header-anchor" href="#_7-1-3-配置支持" aria-label="Permalink to &quot;7.1.3. 配置支持&quot;">​</a></h4><ol><li>支持根据环境变量修改 <code>manifest</code> 中 <code>h5.router.base</code>，实现业务上云</li><li>支持小程序下劫持 <code>window</code>, <code>location</code>, <code>localStorage</code> 等变量</li><li>支持 <code>src</code> 等开头的 <code>alias</code></li><li>支持 H5 下三方库设置外链</li></ol><p>对 <code>window/location/localStorage</code> 等变量的劫持并不能用之前的方式，之前是通过 <code>new Vue</code>，然后将那些变量的属性当作 <code>Vue</code> 的 <code>data、computed、method</code> 等。在 Vue3 中，则需要改成 <code>reactive</code> 实现响应式。</p><p>举个例子，对于 <code>cookie</code>，Vue2 的劫持是：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $document</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Vue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      location: $location,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      body: $body,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  computed: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cookie: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">newVal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;uni-app-cookie&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, newVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;uni-app-cookie&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  methods: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(globalThis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> unknown</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GlobalThis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).$document </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $document;</span></span></code></pre></div><p>Vue3 下是</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $document</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reactive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  location: $location,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  body: $body,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  cookie: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">computed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">newVal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      $localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;uni-app-cookie&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, newVal);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;uni-app-cookie&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// vite.config.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  define</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    document</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;globalThis.$document&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_7-2-脚手架" tabindex="-1">7.2. 脚手架 <a class="header-anchor" href="#_7-2-脚手架" aria-label="Permalink to &quot;7.2. 脚手架&quot;">​</a></h3><p>实现 <strong>uni-app + Vue3 项目、普通 Vue3 项目</strong>的脚手架及模版搭建，可以一键创建新的工程、子工程，并接入了研发平台。</p><p>开发者一键创建后，只需安装依赖、配置环境变量两步，就可以进入业务开发，体验与 Vue2 工程一致，无需进行工程配置、Eslint配置等，无额外心智负担。</p><h3 id="_7-3-ci" tabindex="-1">7.3. CI <a class="header-anchor" href="#_7-3-ci" aria-label="Permalink to &quot;7.3. CI&quot;">​</a></h3><p>对 <strong>H5发布、小程序CI、合包流水线</strong>做了改造，均支持 Vue3 项目，普通开发者无感知。</p><ul><li>H5发布同样支持 <code>history</code> 模式 和 <code>hash</code> 模式，编译速度更快</li><li>小程序CI同样支持微信和QQ双端，支持包大小记录、消息通知、错误提醒等</li><li>合包流水线支持其他子工程扩展，有一定通用性</li></ul><h3 id="_7-4-代码规范" tabindex="-1">7.4. 代码规范 <a class="header-anchor" href="#_7-4-代码规范" aria-label="Permalink to &quot;7.4. 代码规范&quot;">​</a></h3><p>样式规范无需变化，至于 <code>Eslint</code> 规范，发布了 <code>eslint-config-light-vue3</code>，更适合 <code>Vue3</code> 项目，并已对齐公司规范。</p><h3 id="_7-5-组件库和工具库" tabindex="-1">7.5. 组件库和工具库 <a class="header-anchor" href="#_7-5-组件库和工具库" aria-label="Permalink to &quot;7.5. 组件库和工具库&quot;">​</a></h3><p>组件库和工具库同时支持 Vue2 和 Vue3，这一点尤为重要，只有底层组件和工具都支持了，上层业务升级时才有底气。</p><p>Press UI 组件库支持 <code>2*(n+1)</code> 端，<code>2</code> 指的是 Vue2 + Vue3，<code>n</code> 指的是 uni-app 支持的 H5、各种小程序、APP等，<code>1</code> 指的是非 uni-app 的 H5。</p><p>工欲善其事，必先利其器。Press UI 组件库其实就是“利好的器”。</p>`,229)]))}const E=i(p,[["render",l]]);export{c as __pageData,E as default};
