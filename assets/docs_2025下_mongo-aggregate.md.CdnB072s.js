import{_ as a,c as i,o as e,a2 as n}from"./chunks/framework.CriqKoQt.js";const c=JSON.parse('{"title":"MongoDB Aggregate 核心阶段（$match/$project/$group/$sort）及分页详解","description":"","frontmatter":{},"headers":[],"relativePath":"docs/2025下/mongo-aggregate.md","filePath":"docs/2025下/mongo-aggregate.md","lastUpdated":1767879285000}'),t={name:"docs/2025下/mongo-aggregate.md"};function l(h,s,p,d,o,k){return e(),i("div",null,s[0]||(s[0]=[n(`<h1 id="mongodb-aggregate-核心阶段-match-project-group-sort-及分页详解" tabindex="-1">MongoDB Aggregate 核心阶段（$match/$project/$group/$sort）及分页详解 <a class="header-anchor" href="#mongodb-aggregate-核心阶段-match-project-group-sort-及分页详解" aria-label="Permalink to &quot;MongoDB Aggregate 核心阶段（$match/$project/$group/$sort）及分页详解&quot;">​</a></h1><p>你想了解 MongoDB 聚合管道中 <code>$match</code>、<code>$project</code>、<code>$group</code>、<code>$sort</code> 的作用，以及聚合分页的实现方式，下面逐一拆解说明：</p><h2 id="一、聚合管道-aggregate-核心阶段详解" tabindex="-1">一、聚合管道（Aggregate）核心阶段详解 <a class="header-anchor" href="#一、聚合管道-aggregate-核心阶段详解" aria-label="Permalink to &quot;一、聚合管道（Aggregate）核心阶段详解&quot;">​</a></h2><p>MongoDB 的 <code>aggregate()</code> 是基于<strong>管道思想</strong>的数据分析工具，每个管道阶段（如 <code>$match</code>、<code>$project</code>）会接收上一阶段的输出作为输入，处理后传递给下一阶段，最终得到目标结果。</p><h3 id="_1-match-数据筛选-过滤" tabindex="-1">1. <code>$match</code>：数据筛选（过滤） <a class="header-anchor" href="#_1-match-数据筛选-过滤" aria-label="Permalink to &quot;1. \`$match\`：数据筛选（过滤）&quot;">​</a></h3><h4 id="作用" tabindex="-1">作用 <a class="header-anchor" href="#作用" aria-label="Permalink to &quot;作用&quot;">​</a></h4><p>类似于普通查询的 <code>find()</code> 条件，<strong>用于在聚合管道初期过滤不需要的文档</strong>，只保留满足条件的文档进入后续管道阶段。</p><h4 id="核心特点" tabindex="-1">核心特点 <a class="header-anchor" href="#核心特点" aria-label="Permalink to &quot;核心特点&quot;">​</a></h4><ul><li>尽可能放在管道最前面：减少后续阶段处理的数据量，提升聚合效率（可利用索引优化查询）</li><li>支持与 <code>find()</code> 相同的查询操作符（<code>$eq</code>、<code>$gt</code>、<code>$in</code>、<code>$regex</code> 等）</li></ul><h4 id="示例" tabindex="-1">示例 <a class="header-anchor" href="#示例" aria-label="Permalink to &quot;示例&quot;">​</a></h4><p>筛选出 <code>age</code> 大于 20 且 <code>gender</code> 为 &quot;male&quot; 的用户文档：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db.users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aggregate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $match: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      age: { $gt: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      gender: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;male&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><h3 id="_2-project-字段投影-筛选-重命名-计算" tabindex="-1">2. <code>$project</code>：字段投影（筛选/重命名/计算） <a class="header-anchor" href="#_2-project-字段投影-筛选-重命名-计算" aria-label="Permalink to &quot;2. \`$project\`：字段投影（筛选/重命名/计算）&quot;">​</a></h3><h4 id="作用-1" tabindex="-1">作用 <a class="header-anchor" href="#作用-1" aria-label="Permalink to &quot;作用&quot;">​</a></h4><p><strong>控制文档的字段展示形式</strong>，支持三种核心操作：</p><ol><li>保留需要的字段、排除不需要的字段（类似 <code>find()</code> 的第二个参数）</li><li>重命名字段</li><li>生成新的计算字段（基于原有字段做运算、拼接等）</li></ol><h4 id="核心特点-1" tabindex="-1">核心特点 <a class="header-anchor" href="#核心特点-1" aria-label="Permalink to &quot;核心特点&quot;">​</a></h4><ul><li>用 <code>1</code> 表示保留字段，<code>0</code> 表示排除字段（<code>_id</code> 字段默认保留，需手动指定 <code>_id: 0</code> 排除）</li><li>支持通过 <code>$</code> 引用原有字段，进行算术运算、字符串拼接等</li></ul><h4 id="示例-1" tabindex="-1">示例 <a class="header-anchor" href="#示例-1" aria-label="Permalink to &quot;示例&quot;">​</a></h4><p>保留 <code>name</code> 字段，排除 <code>_id</code>，重命名 <code>age</code> 为 <code>userAge</code>，新增 <code>fullName</code> 字段（拼接 <code>firstName</code> 和 <code>lastName</code>）：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db.users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aggregate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $project: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      _id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      name: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      userAge: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$age&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 重命名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fullName: { $concat: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$firstName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$lastName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] } </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 新增计算字段</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><h3 id="_3-group-数据分组聚合" tabindex="-1">3. <code>$group</code>：数据分组聚合 <a class="header-anchor" href="#_3-group-数据分组聚合" aria-label="Permalink to &quot;3. \`$group\`：数据分组聚合&quot;">​</a></h3><h4 id="作用-2" tabindex="-1">作用 <a class="header-anchor" href="#作用-2" aria-label="Permalink to &quot;作用&quot;">​</a></h4><p><strong>按照指定字段对文档进行分组，并对每组数据进行聚合计算</strong>（如统计数量、求和、平均值等），类似 SQL 中的 <code>GROUP BY</code>。</p><h4 id="核心特点-2" tabindex="-1">核心特点 <a class="header-anchor" href="#核心特点-2" aria-label="Permalink to &quot;核心特点&quot;">​</a></h4><ul><li>必须指定 <code>_id</code> 字段：用于定义分组依据（<code>_id: &quot;$gender&quot;</code> 按性别分组，<code>_id: null</code> 表示全局分组（所有文档为一组））</li><li>支持多种聚合操作符：<code>$sum</code>（求和）、<code>$avg</code>（平均值）、<code>$count</code>（计数）、<code>$max</code>/<code>$min</code>（最大/最小值）等</li></ul><h4 id="示例-2" tabindex="-1">示例 <a class="header-anchor" href="#示例-2" aria-label="Permalink to &quot;示例&quot;">​</a></h4><p>按 <code>gender</code> 字段分组，统计每组用户数量（<code>userCount</code>）和平均年龄（<code>avgAge</code>）：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db.users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aggregate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $group: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      _id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$gender&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 分组依据：性别</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      userCount: { $count: {} }, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 计数（等价于 $sum: 1）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      avgAge: { $avg: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$age&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 计算平均年龄</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><h3 id="_4-sort-结果排序" tabindex="-1">4. <code>$sort</code>：结果排序 <a class="header-anchor" href="#_4-sort-结果排序" aria-label="Permalink to &quot;4. \`$sort\`：结果排序&quot;">​</a></h3><h4 id="作用-3" tabindex="-1">作用 <a class="header-anchor" href="#作用-3" aria-label="Permalink to &quot;作用&quot;">​</a></h4><p><strong>对当前管道阶段的文档进行排序</strong>，支持升序或降序排列，类似 SQL 中的 <code>ORDER BY</code>。</p><h4 id="核心特点-3" tabindex="-1">核心特点 <a class="header-anchor" href="#核心特点-3" aria-label="Permalink to &quot;核心特点&quot;">​</a></h4><ul><li>用 <code>1</code> 表示升序，<code>-1</code> 表示降序</li><li>可按单个字段或多个字段排序（多字段排序时，按配置顺序优先级递减）</li><li>若在 <code>$skip</code>/<code>$limit</code>（分页阶段）前使用，可实现有序分页</li></ul><h4 id="示例-3" tabindex="-1">示例 <a class="header-anchor" href="#示例-3" aria-label="Permalink to &quot;示例&quot;">​</a></h4><p>先按 <code>age</code> 降序排序，再按 <code>name</code> 升序排序：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db.users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aggregate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $sort: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      age: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 年龄降序</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      name: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 姓名升序</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><h2 id="二、mongodb-聚合分页实现" tabindex="-1">二、MongoDB 聚合分页实现 <a class="header-anchor" href="#二、mongodb-聚合分页实现" aria-label="Permalink to &quot;二、MongoDB 聚合分页实现&quot;">​</a></h2><p>聚合分页依赖两个专用管道阶段：<code>$skip</code>（跳过指定数量文档）和 <code>$limit</code>（限制返回文档数量），通常与 <code>$sort</code> 配合使用，保证分页结果的一致性。</p><h3 id="_1-分页核心阶段说明" tabindex="-1">1. 分页核心阶段说明 <a class="header-anchor" href="#_1-分页核心阶段说明" aria-label="Permalink to &quot;1. 分页核心阶段说明&quot;">​</a></h3><table tabindex="0"><thead><tr><th>管道阶段</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>$skip</code></td><td>跳过前面 N 条文档，用于指定分页的起始位置</td><td><code>$skip: 20</code>（跳过前 20 条，对应第 3 页，每页 10 条）</td></tr><tr><td><code>$limit</code></td><td>限制返回的文档数量，用于指定每页显示条数</td><td><code>$limit: 10</code>（每页显示 10 条）</td></tr></tbody></table><h3 id="_2-分页完整流程-含排序" tabindex="-1">2. 分页完整流程（含排序） <a class="header-anchor" href="#_2-分页完整流程-含排序" aria-label="Permalink to &quot;2. 分页完整流程（含排序）&quot;">​</a></h3><h4 id="核心逻辑" tabindex="-1">核心逻辑 <a class="header-anchor" href="#核心逻辑" aria-label="Permalink to &quot;核心逻辑&quot;">​</a></h4><p><code>$match</code>（筛选）→ <code>$sort</code>（排序，保证分页有序）→ <code>$skip</code>（跳过前面页数的文档）→ <code>$limit</code>（获取当前页文档）</p><h4 id="公式" tabindex="-1">公式 <a class="header-anchor" href="#公式" aria-label="Permalink to &quot;公式&quot;">​</a></h4><ul><li>跳过文档数 = <code>(当前页码 - 1) * 每页显示条数</code></li><li>示例：第 2 页，每页 10 条 → 跳过 <code>(2-1)*10=10</code> 条</li></ul><h4 id="完整示例" tabindex="-1">完整示例 <a class="header-anchor" href="#完整示例" aria-label="Permalink to &quot;完整示例&quot;">​</a></h4><p>查询 <code>gender</code> 为 &quot;female&quot; 的用户，按 <code>age</code> 降序排序，实现第 2 页、每页 10 条的分页：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 分页参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pageNum</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 当前页码</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pageSize</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 每页条数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> skipCount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (pageNum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pageSize; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 跳过的文档数</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db.users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aggregate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1. 筛选数据（尽可能放在最前面）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { $match: { gender: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;female&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } },</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2. 排序（保证分页结果一致，必须在 skip/limit 前）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { $sort: { age: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } },</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 3. 跳过前面的文档</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { $skip: skipCount },</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 4. 限制当前页返回条数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { $limit: pageSize },</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 可选：投影需要的字段</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { $project: { _id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, name: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, age: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, gender: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><h3 id="_3-分页总数查询-可选-用于计算总页数" tabindex="-1">3. 分页总数查询（可选，用于计算总页数） <a class="header-anchor" href="#_3-分页总数查询-可选-用于计算总页数" aria-label="Permalink to &quot;3. 分页总数查询（可选，用于计算总页数）&quot;">​</a></h3><p>若需要显示总页数（如“共 5 页”），需额外执行一次聚合，用 <code>$count</code> 统计符合条件的总文档数：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 查询总条数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db.users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aggregate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { $match: { gender: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;female&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } }, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 与分页查询的筛选条件一致</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { $count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;total&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 统计总文档数，返回 { total: 45 } 格式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 总页数 = Math.ceil(总条数 / 每页条数) → Math.ceil(45 / 10) = 5 页</span></span></code></pre></div><h2 id="三、注意事项" tabindex="-1">三、注意事项 <a class="header-anchor" href="#三、注意事项" aria-label="Permalink to &quot;三、注意事项&quot;">​</a></h2><ol><li>管道顺序影响性能：<code>$match</code> 尽量放在最前，<code>$sort</code> 放在 <code>$skip</code>/<code>$limit</code> 前，避免无效排序/分页</li><li>大数据量分页：<code>$skip</code> 在数据量极大时（如跳过 10 万条以上）性能较差，可优化为“基于最后一条文档的字段值分页”（如按 <code>_id</code> 或时间戳）</li><li>索引优化：为 <code>$match</code> 和 <code>$sort</code> 的字段建立索引，大幅提升聚合效率</li></ol><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><ol><li><code>$match</code>：筛选文档，减少后续处理量；<code>$project</code>：控制字段展示/生成计算字段</li><li><code>$group</code>：按字段分组并做聚合统计；<code>$sort</code>：对文档进行升序/降序排列</li><li>聚合分页：核心是 <code>$skip</code>（跳过前 N 条）+ <code>$limit</code>（每页条数），配合 <code>$sort</code> 保证有序，总条数用 <code>$count</code> 查询</li><li>分页公式：跳过数 = <code>(当前页码-1) * 每页条数</code>，管道顺序建议：<code>$match</code> → <code>$sort</code> → <code>$skip</code> → <code>$limit</code></li></ol>`,56)]))}const E=a(t,[["render",l]]);export{c as __pageData,E as default};
