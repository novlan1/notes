### 1. 开始

前端相关的白名单包括游戏内测试入口、现网vConsole、现网添加虚拟队员等。

当前白名单管理存在以下问题：

1. 没有有效期控制，离职人员、外部临时测试人员拥有无限期的入口访问权限

2. 只有 `opened`，没有姓名（身份）与`openid`的对应关系

3. 所有游戏的入口白名单是同一份，一个外部测试人员想开王者的入口，结果所有游戏的入口都开了

由于当前的白名单没有清理机制，而人员变动又较频繁，所以很可能被某些人恶意截图、录屏发到网上。一旦发生，可能泄漏业务敏感信息、影响团队的口碑，并且由于是游戏内入口，甚至可能影响到游戏。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/5/own_mike_tAJ5QMD5Z2rr5AeS.png" width="400">

### 2. 设计

由于存在以上问题，重新做了下白名单管理。设计原则为安全、简单、易扩展。

- 独立的申请、审批、删除、查看，可以放在前端研发平台
- 前端管理原始数据，页面可以请求COS数据进行白名单检验，也可以请求后台接口，后台依据此COS数据，判断权限

### 3. 实现

由于 myoa 创建单据回调地址只能是 oa 区或者 idc 区，当前前端管理的服务器基本是 devnet，所以自行创建 myoa 单据并不可行。这里借助了蓝盾流水线。

1. 用户在研发平台申请，研发平台后台远程调用蓝盾流水线，等待审批。同时生成操作记录、白名单单据
2. 审批通过后，回调给研发平台后台。研发平台后台将修改白名单单据状态、操作记录状态，以及修改COS数据
3. 管理定时任务，根据单据有效期、申请时间判读是否过期，清理过期时间，并更新COS数据

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/5/own_mike_cWpmWYSWGSjG3r6d.png" width="600">

这里为了简单用了COS数据，每种不同的权限类型（区分游戏）有不同的COS文件。COS文件为了保护隐私只放 Open Id，如果还是担心有风险，可进一步 md5 加密。甚至可以走后台，后台读取此文件，判断是否为白名单。

权限类型列表（区分游戏）、审批人、COS文件名等都放到七彩石维护，不同权限（区分游戏）审批人都可以单独设置。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/5/own_mike_EPywRB6rjbNz4rCz.png" width="400">

每次权限变动都发送机器人通知，避免预期之外的变动。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/5/own_mike_2F7tJSae8YJHFiiW.png" width="400">

细节部分，openId 和权限类型是主键，每次创建单据，都检查库里有没有，没有的话，直接入库。有的话，并且 `status` 是 `pending`，则报错单据已存在，如果 `status` 不是 `pending`，则更新这条单据的其他信息，尤其是 `status` 更新为 `pending`。

### 4. 申请地址

研发平台申请入口[点击这里](https://mobile.a.com/rd-platform-web/#/management/white/new)，有需要的可以自助申请。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/5/own_mike_nE4xNXWkeANziEnE.png" width="600">
